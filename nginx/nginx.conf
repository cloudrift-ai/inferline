# Custom configuration for nginx-proxy
# This file is placed in /etc/nginx/conf.d/ and will be included in the http context

# Timeout settings (these complement the environment variables in docker-compose.yml)
client_body_timeout 300s;
client_header_timeout 300s;
# keepalive_timeout 300s;
send_timeout 300s;

# Connection queue settings
# Increase buffer sizes to handle more connections
client_body_buffer_size 128k;
client_max_body_size 10m;
large_client_header_buffers 4 16k;

# Buffering settings to handle more connections
proxy_buffering on;
proxy_buffers 8 16k;
proxy_buffer_size 32k;
proxy_busy_buffers_size 64k;
proxy_request_buffering on;

# Keep connections alive
keepalive_requests 1000;

# Configure proxy timeouts for retries
proxy_next_upstream error timeout http_502;
proxy_next_upstream_timeout 60s;
proxy_next_upstream_tries 3;

# Connection queue implementation
# When max_conns is reached, new connections will be queued
proxy_max_temp_file_size 0;
proxy_ignore_client_abort on;

# Set default error page for connection limits
error_page 503 /503.html;

# Set maximum number of connections per server
# This is the key setting for connection queuing
proxy_connect_timeout 300s;
proxy_read_timeout 300s;
proxy_send_timeout 300s;
